//	New RO 2-pass heatshield configuration paradigm:
//		Pass 1 (RealismOverhaul): Prepare parts from other mods for applying RO formulas
//		Pass 2 (RealismOverhaul_HeatShields): Apply formulae for Ablator, Charred Ablator, Thermal Physics
//	RO-aware mods should configure parts either BEFORE[RealismOverhaul] or AFTER[RealismOverhaul]
//	To make specific deviations from these rules, apply edits in AFTER[RealismOverhaul_HeatShields]
//	This file primarily implements Pass 2.

// Un-apply DRE patch to consistently operate on ModuleAblator
@PART:HAS[@MODULE[ModuleHeatShield]]:BEFORE[RealismOverhaul]
{
	@MODULE[ModuleHeatShield]
	{
		@name = ModuleAblator
	}
}

// Apply physics properties for Lunar-rated shield
@PART:HAS[#heatShieldTag[Lunar]]:FOR[RealismOverhaul_HeatShield]
{
	%maxTemp = 2400
	%skinMaxTemp = 3600
	%heatShieldDensity = 0.0125
	%heatShieldAblator = 62.5

	MODULE
	{
		name = ModuleAblator
		ablativeResource = Ablator
		outputResource = CharredAblator
		outputMult = 0.75
		lossExp = -25000
		lossConst = 350
		pyrolysisLossFactor = 30000
		ablationTempThresh = 1250
		reentryConductivity = 0.0025
		infoTemp = 3000
	}
}

// Apply physics properties for Gemini-rated shield
@PART:HAS[#heatShieldTag[Gemini]]:FOR[RealismOverhaul_HeatShield]
{
	%maxTemp = 1300
	%skinMaxTemp = 3350
	%heatShieldDensity = 0.01
	%heatShieldAblator = 37 // Gemini used 1.145x the weight for 1.48x the area
	%thermalMassModifier = 2.5
	%skinMassPerArea = 5.0
	%skinInternalConductionMult = 0.25
	%emissiveConstant = 0.8

	MODULE
	{
		name = ModuleAblator
		ablativeResource = Ablator
		outputResource = CharredAblator
		outputMult = 1
		lossExp = -8600
		lossConst = 0.214
		pyrolysisLossFactor = 102625
		ablationTempThresh = 750
		reentryConductivity = 0.0065
	}
}

// Apply physics properties for LEO-rated shield
@PART:HAS[#heatShieldTag[LEO]]:FOR[RealismOverhaul_HeatShield]
{
	%maxTemp = 1300
	%skinMaxTemp = 2500
	%heatShieldDensity = 0.01
	%heatShieldAblator = 50
	%thermalMassModifier = 2.0
	%skinMassPerArea = 4.0
	%skinInternalConductionMult = 0.25
	%emissiveConstant = 0.8

	MODULE
	{
		name = ModuleAblator
		ablativeResource = Ablator
		outputResource = CharredAblator
		outputMult = 1
		lossExp = -6000
		lossConst = 0.13
		pyrolysisLossFactor = 8210
		ablationTempThresh = 750
		reentryConductivity = 0.0065
	}
}

@PART:HAS[#resetHeatShieldMass[?rue],#heatShieldDiameter,#heatShieldDensity]:FOR[RealismOverhaul_HeatShield]
{
	%mass = #$heatShieldDiameter$
	@mass != 2
	@mass *= #$heatShieldDensity$
}

@PART:HAS[#resetHeatShieldAblator[?rue],#heatShieldDiameter,#heatShieldAblator]:FOR[RealismOverhaul_HeatShield]
{
	!RESOURCE[Ablator] {}
	RESOURCE
	{
		name = Ablator
		maxAmount = #$../heatShieldDiameter$
		@maxAmount != 2
		@maxAmount *= #$../heatShieldAblator$
	}
}

// Finish configuration: Ablator resources, Charred Ablator
@PART:HAS[#heatShieldTag]:FOR[RealismOverhaul_HeatShield]
{
	%RSSROConfig = True

	@MODULE[ModuleAblator]:HAS[~outputMult[]]
	{
		%outputMult = 1
	}
	@RESOURCE[Ablator]
	{
		amount = #$maxAmount$
	}
	RESOURCE
	{
		name = CharredAblator
		maxAmount = #$../RESOURCE[Ablator]/maxAmount$
		@maxAmount *= #$../MODULE[ModuleAblator]/outputMult$
		amount = 0
	}
}

@PART:HAS[@MODULE[ModuleAblator]]:NEEDS[DeadlyReentry]:FOR[RealismOverhaul_HeatShield_Late]
{
	@MODULE[ModuleAblator]
	{
		@name = ModuleHeatShield
		%depletedMaxTemp = 1200
	}
}
@PART:HAS[#heatShieldTag]:FOR[RealismOverhaul_HeatShield_Late]
{
	!heatShieldTag = DEL
	!heatShieldDiameter = DEL
	!resetHeatShieldAblator = DEL
	!resetHeatShieldMass = DEL
	!heatShieldDensity = DEL
	!heatShieldAblator = DEL
}
@PART:HAS[#heatShieldDiameter]:FOR[RealismOverhaul_HeatShield_Late]
{
	!heatShieldTag = DEL
	!heatShieldDiameter = DEL
	!resetHeatShieldAblator = DEL
	!resetHeatShieldMass = DEL
	!heatShieldDensity = DEL
	!heatShieldAblator = DEL
}
